<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Page - Manage Images</title>
    <style>
        .image-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .image-wrapper {
            display: inline-block;
            position: relative;
        }
        .image-wrapper img {
            width: 100px;
            height: 100px;
            object-fit: cover;
        }
        .upload-form {
            margin-bottom: 20px;
        }
        .dragging {
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <h1>Manage Images</h1>
    <a href="index.html">Home Page</a>

    <!-- Image Upload Form -->
    <div class="upload-form">
        <form id="uploadForm" enctype="multipart/form-data">
            <input type="file" name="imageFiles" id="imageFiles" accept="image/*" multiple>
            <button type="submit">Upload Images</button>
        </form>
        <p id="uploadStatus"></p>
    </div>

    <!-- Image Sorting and Deletion Section -->
    <div id="imageContainer" class="image-container"></div>
    <button id="saveOrderBtn">Save Order</button>

    <script>
        let draggedItem = null;
        const imageContainer = document.getElementById("imageContainer");

        function loadImages() {
            fetch("/images")
                .then(response => response.json())
                .then(data => {
                    imageContainer.innerHTML = "";
                    data.forEach((imgPath, index) => {
                        const imgElement = document.createElement("img");
                        imgElement.src = imgPath;
                        imgElement.draggable = true;
                        imgElement.dataset.index = index;

                        const deleteButton = document.createElement("button");
                        deleteButton.textContent = "Delete";
                        deleteButton.addEventListener("click", () => deleteImage(imgPath));

                        const wrapper = document.createElement("div");
                        wrapper.className = "image-wrapper";
                        wrapper.appendChild(imgElement);
                        wrapper.appendChild(deleteButton);

                        wrapper.addEventListener("dragstart", dragStart);
                        wrapper.addEventListener("dragover", dragOver);
                        wrapper.addEventListener("drop", drop);
                        wrapper.addEventListener("dragend", dragEnd);

                        imageContainer.appendChild(wrapper);
                    });
                })
                .catch(error => console.error('Error loading images:', error));
        }

        function dragStart(e) {
            draggedItem = this;
            setTimeout(() => this.classList.add("dragging"), 0);
        }

        function dragEnd() {
            this.classList.remove("dragging");
            draggedItem = null;
        }

        function dragOver(e) {
            e.preventDefault();
            const draggingOverItem = this;
            if (draggedItem !== draggingOverItem) {
                const allItems = Array.from(imageContainer.children);
                const draggingIndex = allItems.indexOf(draggedItem);
                const overIndex = allItems.indexOf(draggingOverItem);
                if (draggingIndex < overIndex) {
                    imageContainer.insertBefore(draggedItem, draggingOverItem.nextSibling);
                } else {
                    imageContainer.insertBefore(draggedItem, draggingOverItem);
                }
            }
        }

        function drop(e) {
            e.preventDefault();
        }

        function deleteImage(imgPath) {
            fetch("/delete-image", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ path: imgPath })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert("Image deleted successfully!");
                    loadImages();
                } else {
                    alert("Failed to delete image.");
                }
            })
            .catch(error => console.error('Error deleting image:', error));
        }

        document.getElementById("saveOrderBtn").addEventListener("click", () => {
            const newOrder = Array.from(imageContainer.children).map(wrapper => {
                const imgElement = wrapper.querySelector("img");
                return imgElement.src;
            });

            fetch("/save-order", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ order: newOrder })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert("Image order saved successfully!");
                } else {
                    alert("Failed to save image order.");
                }
            })
            .catch(error => console.error('Error saving image order:', error));
        });

        document.getElementById("uploadForm").addEventListener("submit", function(e) {
            e.preventDefault();
            const formData = new FormData();
            const imageFiles = document.getElementById("imageFiles").files;

            for (let i = 0; i < imageFiles.length; i++) {
                formData.append("imageFiles", imageFiles[i]);
            }

            fetch("/upload-multiple", {
                method: "POST",
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById("uploadStatus").textContent = data.message;
                loadImages();
            })
            .catch(error => {
                document.getElementById("uploadStatus").textContent = "Error uploading images";
                console.error('Error uploading images:', error);
            });
        });

        window.onload = loadImages;
    </script>
</body>
</html>
