<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Page - Manage Images</title>
    <style>
        .image-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .image-wrapper {
            display: inline-block;
            position: relative;
        }
        .image-wrapper img {
            width: 100px;
            height: 100px;
            object-fit: cover;
        }
        .image-wrapper.dragging {
            opacity: 0.5;
        }
        .upload-form {
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <h1>Manage Images</h1>
    <h1><a href="index.html">Home page</a></h1>

    <!-- Image Upload Form -->
    <div class="upload-form">
        <form id="uploadForm" enctype="multipart/form-data">
            <input type="file" name="imageFiles" id="imageFiles" accept="image/*" multiple> <!-- Allow multiple files -->
            <button type="submit">Upload Images</button>
        </form>
        <p id="uploadStatus"></p>
    </div>

    <!-- Image Sorting Section -->
    <div id="imageContainer" class="image-container"></div>
    <button id="saveOrderBtn">Save Order</button>

    <script>
        let draggedItem = null;
        const imageContainer = document.getElementById("imageContainer");

        // Fetch and display the images
        function loadImages() {
            fetch("/images")
                .then(response => response.json())
                .then(data => {
                    imageContainer.innerHTML = ""; // Clear existing images
                    data.forEach((imgPath, index) => {
                        const imgElement = document.createElement("img");
                        imgElement.src = imgPath;
                        imgElement.draggable = true;  // Make images draggable
                        imgElement.dataset.index = index;  // Store image index

                        const wrapper = document.createElement("div");
                        wrapper.className = "image-wrapper";
                        wrapper.appendChild(imgElement);

                        wrapper.addEventListener("dragstart", dragStart);
                        wrapper.addEventListener("dragover", dragOver);
                        wrapper.addEventListener("drop", drop);
                        wrapper.addEventListener("dragend", dragEnd);

                        imageContainer.appendChild(wrapper);
                    });
                });
        }

        function dragStart(e) {
            draggedItem = this;
            setTimeout(() => {
                this.classList.add("dragging");
            }, 0);
        }

        function dragEnd() {
            this.classList.remove("dragging");
            draggedItem = null;
        }

        function dragOver(e) {
            e.preventDefault();
            const draggingOverItem = this;
            if (draggedItem !== draggingOverItem) {
                const allItems = Array.from(imageContainer.children);
                const draggingIndex = allItems.indexOf(draggedItem);
                const overIndex = allItems.indexOf(draggingOverItem);
                if (draggingIndex < overIndex) {
                    imageContainer.insertBefore(draggedItem, draggingOverItem.nextSibling);
                } else {
                    imageContainer.insertBefore(draggedItem, draggingOverItem);
                }
            }
        }

        function drop() {
            // Handle drop if needed
        }

        // Save the new order of images
        document.getElementById("saveOrderBtn").addEventListener("click", () => {
            const newOrder = Array.from(imageContainer.children).map(wrapper => {
                const imgElement = wrapper.querySelector("img");
                return imgElement.src;
            });

            fetch("/save-order", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ order: newOrder })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert("Image order saved successfully!");
                } else {
                    alert("Failed to save image order.");
                }
            });
        });

        // Handle Image Upload (Multiple Images)
        document.getElementById("uploadForm").addEventListener("submit", function (e) {
            e.preventDefault();
            const formData = new FormData();
            const imageFiles = document.getElementById("imageFiles").files; // Get all selected files

            for (let i = 0; i < imageFiles.length; i++) {
                formData.append("imageFiles", imageFiles[i]); // Append each file to the form data
            }

            fetch("/upload-multiple", { // Change to new route for multiple uploads
                method: "POST",
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById("uploadStatus").textContent = data.message;
                loadImages();  // Reload images after successful upload
            })
            .catch(err => {
                document.getElementById("uploadStatus").textContent = "Error uploading images";
            });
        });

        // Load images when the page loads
        window.onload = loadImages;
    </script>
</body>
</html>
